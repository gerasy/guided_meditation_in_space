<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guided Meditation - Breathing in Space</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <!-- Starfield Background -->
    <div class="stars" id="stars"></div>

    <!-- Debug Panel (toggle with 'D' key) -->
    <div class="debug-panel" id="debug-panel" style="display: none;">
        <h4>Audio Features</h4>
        <div class="debug-row">
            <span class="debug-label">Envelope:</span>
            <span class="debug-value" id="debug-envelope">0.00</span>
        </div>
        <div class="debug-bar"><div class="debug-bar-fill" id="debug-envelope-bar"></div></div>
        <div class="debug-row">
            <span class="debug-label">Slope:</span>
            <span class="debug-value" id="debug-slope">0.000</span>
        </div>
        <div class="debug-row">
            <span class="debug-label">Centroid:</span>
            <span class="debug-value" id="debug-centroid">0 Hz</span>
        </div>
        <div class="debug-row">
            <span class="debug-label">ZCR:</span>
            <span class="debug-value" id="debug-zcr">0.00</span>
        </div>
        <div class="debug-row">
            <span class="debug-label">Breath Score:</span>
            <span class="debug-value" id="debug-breath-score">0%</span>
        </div>
        <div class="debug-bar"><div class="debug-bar-fill" id="debug-score-bar" style="background: #4af;"></div></div>
        <div class="debug-row">
            <span class="debug-label">Phase:</span>
            <span class="debug-value" id="debug-phase">idle</span>
        </div>
        <div class="debug-row">
            <span class="debug-label">Talking:</span>
            <span class="debug-value" id="debug-talking">No</span>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">

        <!-- Welcome Screen -->
        <div class="screen active" id="welcome-screen">
            <h1>Breathing in Space</h1>
            <p>
                Welcome to your guided meditation journey through the cosmos.<br>
                We'll practice breathing exercises together, with visual guidance to help you sync your breath.
            </p>
            <p>
                This experience uses your microphone to detect your breathing patterns.<br>
                First, we'll calibrate the system to your unique breathing.
            </p>
            <button class="btn" id="start-btn">Begin Journey</button>
        </div>

        <!-- Microphone Permission Screen -->
        <div class="screen" id="permission-screen">
            <h2>Microphone Access</h2>
            <p>
                To detect your breathing, we need access to your microphone.<br>
                Your audio is processed locally and never leaves your device.
            </p>
            <button class="btn" id="permission-btn">Allow Microphone</button>
            <p id="permission-error" style="color: #f88; display: none;"></p>
        </div>

        <!-- Calibration Screen -->
        <div class="screen" id="calibration-screen">
            <h2>Calibration Setup</h2>

            <div class="calibration-status">
                <div class="calibration-item">
                    <div class="calibration-dot" id="cal-silence-dot"></div>
                    <span>Silence</span>
                </div>
                <div class="calibration-item">
                    <div class="calibration-dot" id="cal-talking-dot"></div>
                    <span>Talking</span>
                </div>
                <div class="calibration-item">
                    <div class="calibration-dot" id="cal-breathin-dot"></div>
                    <span>Breathe In</span>
                </div>
                <div class="calibration-item">
                    <div class="calibration-dot" id="cal-breathout-dot"></div>
                    <span>Breathe Out</span>
                </div>
            </div>

            <div class="instruction" id="calibration-instruction">
                Preparing calibration...
            </div>

            <div class="sphere single-sphere" id="calibration-sphere">
                <div class="sphere-fill" id="calibration-fill"></div>
                <div class="sphere-glow"></div>
            </div>

            <div class="audio-level">
                <div class="audio-level-fill" id="audio-level-fill"></div>
            </div>

            <div class="timing-info" id="timing-info"></div>

            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="calibration-progress"></div>
                </div>
                <div class="progress-text" id="calibration-progress-text">Step 1 of 4</div>
            </div>
        </div>

        <!-- Ready Screen -->
        <div class="screen" id="ready-screen">
            <h2>Calibration Complete!</h2>

            <div class="calibration-results">
                <h3>Your Breathing Profile</h3>
                <div class="result-row">
                    <span class="result-label">Inhale Duration:</span>
                    <span class="result-value" id="result-inhale">0.0s</span>
                </div>
                <div class="result-row">
                    <span class="result-label">Exhale Duration:</span>
                    <span class="result-value" id="result-exhale">0.0s</span>
                </div>
                <div class="result-row">
                    <span class="result-label">Target Inhale:</span>
                    <span class="result-value" id="result-target-in">4.0s</span>
                </div>
                <div class="result-row">
                    <span class="result-label">Target Exhale:</span>
                    <span class="result-value" id="result-target-out">4.0s</span>
                </div>
                <div class="adjustment-hint" id="adjustment-hint"></div>
            </div>

            <p>
                You'll see two spheres:<br>
                <strong style="color: #8af;">Blue</strong> - Follow this guide<br>
                <strong style="color: #8f8;">Green</strong> - Your detected breathing
            </p>
            <p>We'll gradually adjust to help you reach the target pace.</p>
            <button class="btn" id="begin-meditation-btn">Start Meditation</button>
        </div>

        <!-- Meditation Screen -->
        <div class="screen" id="meditation-screen">
            <div class="round-counter" id="round-counter">Round 1 of 5</div>

            <div class="breathing-phase" id="breathing-phase">Get Ready...</div>

            <div class="spheres-container">
                <div class="sphere-wrapper">
                    <div class="sphere-label">Guide</div>
                    <div class="sphere guide" id="guide-sphere">
                        <div class="sphere-fill" id="guide-fill"></div>
                        <div class="sphere-glow"></div>
                    </div>
                </div>
                <div class="sphere-wrapper">
                    <div class="sphere-label">You</div>
                    <div class="sphere user" id="user-sphere">
                        <div class="sphere-fill" id="user-fill"></div>
                        <div class="sphere-glow"></div>
                    </div>
                </div>
            </div>

            <div class="timer" id="meditation-timer">4</div>

            <div class="talking-warning" id="talking-warning"></div>
            <div class="feedback" id="feedback"></div>

            <button class="btn secondary" id="stop-meditation-btn" style="margin-top: 20px;">End Session</button>
        </div>

        <!-- Completion Screen -->
        <div class="screen" id="completion-screen">
            <h2>Session Complete!</h2>
            <p>Wonderful job on completing your breathing meditation.</p>

            <div class="completion-stats">
                <div class="stat-item">
                    <div class="stat-value" id="stat-rounds">5</div>
                    <div class="stat-label">Rounds Completed</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="stat-duration">0:00</div>
                    <div class="stat-label">Total Duration</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="stat-sync">0%</div>
                    <div class="stat-label">Average Sync</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="stat-breaths">0</div>
                    <div class="stat-label">Total Breaths</div>
                </div>
            </div>

            <button class="btn" id="restart-btn">Start Again</button>
        </div>
    </div>

    <!-- JavaScript Modules (order matters) -->
    <script src="js/config.js"></script>
    <script src="js/state.js"></script>
    <script src="js/audio.js"></script>
    <script src="js/speech.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/calibration.js"></script>
    <script src="js/meditation.js"></script>
    <script src="js/app.js"></script>
</body>
</html>
